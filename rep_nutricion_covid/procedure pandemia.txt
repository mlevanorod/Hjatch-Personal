USE [BDPERSONAL]
GO
 Object  StoredProcedure [dbo].[SP_GET_ASISTENCIA_MAESTRO_NUTRICION]    Script Date 06012021 095719 
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


ALTER  PROCEDURE [dbo].[SP_GET_ASISTENCIA_MAESTRO_NUTRICION]	
					@FECHA  VARCHAR(10),
					@TURNO	CHAR(1)
AS	
BEGIN	
	
	DECLARE @DIA VARCHAR (2)
	DECLARE @MES VARCHAR(2)
	DECLARE @ANIO VARCHAR(4)
	DECLARE @ROL1 CHAR(2)
	DECLARE @ROL2 CHAR(1)
	DECLARE @ROL3 CHAR(2)
	DECLARE @ROL4 CHAR(3)
	DECLARE @ROL5 CHAR(3)
	--PARA DESAYUNOS DE LA GUARDIA DEL DIA ANTERIOR
	DECLARE @DIA_ANT VARCHAR (2)
	DECLARE @MES_ANT VARCHAR(2)
	DECLARE @ANIO_ANT VARCHAR(4)
	DECLARE @FECHA_ANT DATE = DATEADD(DAY,-1,CONVERT(DATE,@FECHA))
	SET @DIA_ANT = DATEPART(DAY,@FECHA_ANT)
	SET @MES_ANT = DATEPART(MONTH,@FECHA_ANT)
	SET @ANIO_ANT = DATEPART(YEAR,@FECHA_ANT)
	--
	select	@DIA = SUBSTRING(@FECHA,1,2),
		@MES = SUBSTRING(@FECHA,4,2),
		@ANIO = SUBSTRING(@FECHA,7,4);

	IF @TURNO = 'A'--ALMUERZO
	BEGIN
	SELECT	C.NOMBRE AS NOMBRE,
			c.CODIGO as CODIGO,
			[dbo].[COD_UNIDAD](C.CODUNIDADORG) AS UNIDAD,
			B.CODTUR,
			B.CODHOR
	  FROM	ASISTENCIA A
	  JOIN	T_Horarios B
		ON	A.CODACT = B.CODHOR  
	  JOIN	MAESTRO C
		ON	A.CODIGO = C.CODIGO
	 WHERE	(A.AÑO = @ANIO
	   AND	A.MES = @MES
	   AND	A.DIA = @DIA
       AND	B.CODTUR IN ('GD','D','DN','XX','GGD',
	   --TEMPORAL POR CORONAVIRUS  AUMENTE DESDE GGD1
	   'GDN','GGD1','GGD2','GGD3','FGN3','FGN2','MTGN1','MTGN2','MTGN3','G5','G4','G3',
	   'G2','G1','TN1','D1','D2','D3','M7','M6','M13','M5','GDN2','GDN1','GDN3','DN1','M2','FGN1')
	   -- 
	   AND	B.CODHOR not in ('D','DM',
	   --TEMPORAL POR CORONAVIRUS
	   'M4')
	   --
	   AND  C.SITUACION  '11' 
	   AND	A.IdServDepartUnid  '13'	)
	   OR
	   (A.AÑO = @ANIO
	   AND	A.MES = @MES
	   AND	A.DIA = @DIA
       AND	B.CODHOR IN ('M7') 
	   AND  A.IdServDepartUnid = '12')
	UNION ALL
	SELECT	C.NOMBRE AS NOMBRE,
			c.CODIGO as CODIGO,
			[dbo].[COD_UNIDAD](C.CODUNIDADORG) AS UNIDAD,
			B.CODTUR,
			B.CODHOR
	  FROM	ASISTENCIA_COMPLE A
	  JOIN	T_Horarios B
		ON	A.CODACT = B.CODHOR  
	  JOIN	MAESTRO C
		ON	A.CODIGO = C.CODIGO
	 WHERE	(A.AÑO = @ANIO
	   AND	A.MES = @MES
	   AND	A.DIA = @DIA
       AND	B.CODTUR IN ('GD','D','DN','XX','GGD',
	   --TEMPORAL POR CORONAVIRUS  AUMENTE DESDE GGD1
	   'GDN','GGD1','GGD2','GGD3','FGN3','FGN2','G5','G4','G3',
	   'G2','G1','TN1','D1','D2','D3','M7','M6','M13','M5','GDN2','GDN1','GDN3','DN1','M2','FGN1')
	   -- 
	   AND	B.CODHOR not in ('D','DM',
	   --TEMPORAL POR CORONAVIRUS
	   'M4')
	   --
	   AND  C.SITUACION  '11' 
	   AND	A.IdServDepartUnid  '13'	)
	   OR
	   (A.AÑO = @ANIO
	   AND	A.MES = @MES
	   AND	A.DIA = @DIA
       AND	B.CODHOR IN ('M7') 
	   AND  A.IdServDepartUnid = '12')
	   ORDER BY NOMBRE
	END
	IF @TURNO = 'D'--DESAYUNO
	BEGIN
	SELECT	C.NOMBRE AS NOMBRE,
			c.CODIGO as CODIGO,
			[dbo].[COD_UNIDAD](C.CODUNIDADORG) AS UNIDAD,
			B.CODTUR,
			B.CODHOR
	  FROM	ASISTENCIA A
	  JOIN	T_Horarios B
		ON	A.CODACT = B.CODHOR  
	  JOIN	MAESTRO C
		ON	A.CODIGO = C.CODIGO
	 WHERE	A.AÑO = @ANIO_ANT
	   AND	A.MES = @MES_ANT
	   AND	A.DIA = @DIA_ANT
       AND	(B.CODHOR LIKE '%N%' or B.CODHOR LIKE 'GGD%' )
	   AND	B.CODHOR != 'D'
	UNION ALL
	SELECT	C.NOMBRE AS NOMBRE,
			c.CODIGO as CODIGO,
			[dbo].[COD_UNIDAD](C.CODUNIDADORG) AS UNIDAD,
			B.CODTUR,
			B.CODHOR
	  FROM	ASISTENCIA_COMPLE A
	  JOIN	T_Horarios B
		ON	A.CODACT = B.CODHOR  
	  JOIN	MAESTRO C
		ON	A.CODIGO = C.CODIGO
	 WHERE	A.AÑO = @ANIO_ANT
	   AND	A.MES = @MES_ANT
	   AND	A.DIA = @DIA_ANT
       AND	(B.CODHOR LIKE '%N%' or B.CODHOR LIKE 'GGD%' )
	   AND	B.CODHOR != 'D'

	   OR
	   (A.AÑO = @ANIO
	   AND	A.MES = @MES
	   AND	A.DIA = @DIA
       AND	B.CODHOR IN ('M7') 
	   AND  A.IdServDepartUnid = '12')

	   ORDER BY NOMBRE
	END
	IF @TURNO = 'C'--CENA
	BEGIN
	SELECT	C.NOMBRE AS NOMBRE,
			c.CODIGO as CODIGO,
			[dbo].[COD_UNIDAD](C.CODUNIDADORG) AS UNIDAD,
			B.CODTUR,
			B.CODHOR
	  FROM	ASISTENCIA A
	  JOIN	T_Horarios B
		ON	A.CODACT = B.CODHOR  
	  JOIN	MAESTRO C
		ON	A.CODIGO = C.CODIGO
	 WHERE	A.AÑO = @ANIO
	   AND	A.MES = @MES
	   AND	A.DIA = @DIA
       AND	(B.CODHOR LIKE '%N%' or B.CODHOR LIKE 'GGD%' )
	   AND	B.CODHOR != 'D'
	UNION ALL
	SELECT	C.NOMBRE AS NOMBRE,
			c.CODIGO as CODIGO,
			[dbo].[COD_UNIDAD](C.CODUNIDADORG) AS UNIDAD,
			B.CODTUR,
			B.CODHOR
	  FROM	ASISTENCIA_COMPLE A
	  JOIN	T_Horarios B
		ON	A.CODACT = B.CODHOR  
	  JOIN	MAESTRO C
		ON	A.CODIGO = C.CODIGO
	 WHERE	A.AÑO = @ANIO
	   AND	A.MES = @MES
	   AND	A.DIA = @DIA
       AND	(B.CODHOR LIKE '%N%' or B.CODHOR LIKE 'GGD%' )
	   AND	B.CODHOR != 'D'
	   ORDER BY NOMBRE
	END
END
